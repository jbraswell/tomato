jobs:
  include:

    - stage: docker build
      services:
        - docker
      script:
        - docker build -f Dockerfile . -t tomato:latest
        - docker tag tomato:latest bmltenabled/tomato:latest
        - docker tag tomato:latest bmltenabled/tomato:$TRAVIS_COMMIT
      before_deploy:
        - chmod +x push-docker-image.sh
      deploy:
        - provider: script
          script: "./push-docker-image.sh"
          skip_cleanup: true
          on:
            branch: travis

    - stage: deploy to ecs
      if: branch IN (travis) AND type != pull_request
      env:
        - AWS_DEFAULT_REGION=us-east-1
        - secure: "TGAVwiI/mqteZiPVqzDbDWG0+A9M0cyU7dG4pFVPhWxDomnLGlqQ/XBuVQo420dE34bVbHn4qDUpj4FgoaTwYDGSYEqxdaYjulEfD8AXUZ7d0eemNd0mt87KCoEk1Lt7a+PkwxD2fu2hPcWmW+7oedcMYCC4UX/DcVXlLsSPkMhL/FDzC55JsZwoUOFH6RVX7Acq9ZkCXCwOFNLevh3A4oAVpdhSu0mcubC+b22hRJPvUsjenoO9h5aZcVRWiHKMS5RGn+8+rs2xjAEBkZ/cTc8yO/SvE9kG5yfWIxrPffRWqhbjaXJZK+tu6f2NCfM1ohW/1dRVQjeWMG48q1lMB6e1vU01HXm03s5gkjLvNTGKbMukmUdH8B+q2LGcyTI81gK5jCCwSyJdJ7T8q0NUEa6aJDlNKoJNoMtsNRVom2ttjAIY0aZ6+Yg1fUzrJBi08HSdM4vpDl8EQeaZoHTPJK15DSeNgHmQ3Bi0NYXtNzgM9/hwxNx9XsZeHQgHQOKb/8vKaJAnhrS8TPsIe/fNXLIFN2UngVsVhJXcE0Z0dOX+L+nroJyXn25a0oEREgimm1+fgmiKjUm+ECLb4uxQl3OgoUQDSzJT1ZNxmeo+sjfy7KXcYVHx26k5fb1nhBMVC9jD7IydzMboWCywTgbGhpbCkyuXhSHlroRL6fbIbWI="
        - secure: "VkAABOgHkDhG8UVgEe3Nwcpj9ro4y7Yc3JTmp2ZqAlxasYfZttwiChU0E0xC8nvKCEb4jxzH5/X/BiBQz3JG7W3+bt/Eqrxr+rOhTGm5hUz7xsCq96TzCgw/pdjIPURLnjHeOo0sWPpBiTf7L5gXxGR2CVOZLlvdK2kaxzB057mNy4Rm5ZqZ0PQyMa/DbITF6GNK0Z/HuP96KfpxSG/Agrh/NWxqfF1bfiuvGRXWU88w0yXpNVNPdSxwHiQU8PGkJN7O0jAUKyFtQCNwMYS/Mm7MIKO0pYyR8PkMBcnlm4VfZc84wB08OpvDixHzR5MC7S9d+NAMi75WmGMOQF1kVWmkyBOkLMR6lwVlEBGA1PxBLwYQXFlwT29orM96ZIVRpSqw2npw0V/Ci9UuVC+HDtKlgAI75rHJF8YRfOll129Br1UZJ4+U7QzmWSSRPVSV8vC4D35lmqHqruttp50/2dte1bN0HbqpMUIJSkFEKHuE/WVqRU79GzZPVShLRJLgN35K+sydP+UsjTAw697TD8KPbTNDU0MOqAhAPoGfOXJEMnjalpEC8EbmTqhVbNOSxK0lI1nQ8KNVSN2p6DbOaK+92N/98LojJ5M6w/E5wpPYBsSZvCf/zvXTVSygQkTX4CsGNGaf3MKSgHiDSFU3ZnBNpVitTm8maKl/uvX0M2A="
        - secure: "oBL5TrjB/emaeY0blavEqkDqi26b5wpD2FVaJgiQKTREl5c/vN5vDbamIwv/KumZmu+GOCJlWVLSKqG/KPwPPbHqHuerwFC/AJein2iV9HQ+iBfa/y6Kyefn0M90DOzkjRr8UY7ZVD/0JqMR4t01WWT5v4qkLzk3C6DOtGvqvbwWNM0y6hNTzHxE3cDopBnOO60ClxUrDZMVGaiIKctBFojyxJ8zf0rvkfZB3nY31aJQz708QKf15lxLn/Pci/EH8mTSDN4/XDlZ7fICaxEDVfb8rkHUz6EVHCuOjnvw23HOiW007FZHoX0mIl8861CPHewNdVmkhUkqhzNSmh4xfkiTsqLkzziZUgbvD5faTr20EAK6VogC7c92D8II/tlQcY5AmRYWzb5aT4TjsDn+MVvu5W01e4YyPs4kpx3jgdqYGj3QVmjx1ThxfgY/Coq+mwI7czMFH1HKv0K3eftQ89wXrQh/fEE+oMO5/iSrbMJL9DD+epyA8OfVZB+4eYLS+7HIzBLNDF7eVPutDMztj7jQjuyJ7rsyOmDqmoBSZkSUMJ8EsjB6mkOz2/9f+U0qNztHi0KLb7rNYw0DqblSHzYfvhyOSOxNI1YY6YBJZDtcrIJAuKY+Mcg9kut88M2zuZ1WS3sV//7xdJdc9npLpw/1C/E6P+e97DCOgmrVUtw="
        - secure: "e9kDMCXYImuUPfDupbH1NwtxK3LpJRA7vmLxkBeAIItv6Mq3+3qKM2rjrtVussBtmzd+94i5MqZ1RWGsyjbnEN2/MN/LyP44cvd9KFK5jbG5jiibvAPm/RSjD/evsOHK4+WX1VOlGncTwqHiVXRuuap6zs0xKZzpVu+CCD4YohO5vp+3EE+8y7Mv6+g1TGry+UjiZ6ukvmXCiift/UhPJ9wbuFNMH3xcH4QfNzBjiX7bjkySbQssLOtiSA4K0DDpZ5rG/e2uVSlromeg4b/LzNXv+c0mvHHFh0ekBS1NWr0vhy19ddkCYN7LzKOOlPcOSzSnA/FbILmZOQtl0MfAkQatjLTA7OONqfKuqii6apzUYWVymGfA00rfUfDyIJjytsOA6P7YqbWIa+srNwdXXDrU7uP/r4v4jQz6McechTnqZH8FbCaeZOGMyYVQTZCvHV94enKOEU5cn+t9JTnC9KciPSFE+GwbuX+a7tBBRu8Ie0YPADr953rFaty+mm51mRN8v3eYEZWl1/6E8L1JEv34cI7M+c6VSx8Rhh+k33I//Wxvk7SNmq2q9bc0yHm6BPEy5ePrCCsYKi1W85oLiSaRSSbTgbSqYBD4+Ws1ttZXmDbiAU6Z5gfcB5EaEhMwh+wH6bPcSLzHPHOs33S7ws47bdT/xR/xtKyNoTtII0M="
      install:
        - cd terraform
        - wget https://releases.hashicorp.com/terraform/0.12.8/terraform_0.12.8_linux_amd64.zip
        - unzip terraform_0.12.8_linux_amd64.zip
        - rm -f terraform_0.12.8_linux_amd64.zip
      script:
        - ./terraform init -input=false
        - ./terraform plan -var image_tag=$TRAVIS_COMMIT
#        - ./terraform apply -var image_tag=$TRAVIS_COMMIT -input=false -auto-approve

